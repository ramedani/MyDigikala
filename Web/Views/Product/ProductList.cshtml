@model List<Application.DTO.ProductListDto>


@{
ViewData["Title"] = "listnews";
Layout = "~/Views/Shared/_admin.cshtml";
var stats = ViewBag.Stats as Application.DTO.ProductDashboardStatsDto;
}

@section css{
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" type="text/css" href="~/admin/app-assets/css-rtl/core/menu/menu-types/vertical-menu.css">
<link rel="stylesheet" type="text/css" href="~/admin/app-assets/css-rtl/core/colors/palette-gradient.css">
<link rel="stylesheet" type="text/css" href="~/admin/app-assets/css-rtl/plugins/file-uploaders/dropzone.css">
<link rel="stylesheet" type="text/css" href="~/admin/app-assets/css-rtl/pages/data-list-view.css">

}
<div class="container-fluid py-4">

    <div class="row g-3 mb-4">
        <!-- Total News -->
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">کل اخبار</h6>
                            <h2 class="fw-bold mb-0">@stats?.TotalProduct</h2>
                        </div>
                        <i class="fas fa-newspaper fa-2x opacity-50"></i>
                    </div>
                    <i class="fas fa-newspaper stat-icon-bg"></i>
                </div>
            </div>
        </div>
        <!-- Published -->
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">منتشر شده</h6>
                            <h2 class="fw-bold mb-0">@stats?.PublishedCount</h2>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-50"></i>
                    </div>
                    <i class="fas fa-check-circle stat-icon-bg"></i>
                </div>
            </div>
        </div>
        <!-- Drafts -->
        <div class="col-md-3">
            <div class="card stat-card bg-warning text-dark shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-black-50 mb-1">پیش‌نویس</h6>
                            <h2 class="fw-bold mb-0">@stats?.DraftCount</h2>
                        </div>
                        <i class="fas fa-pen-ruler fa-2x opacity-50"></i>
                    </div>
                    <i class="fas fa-pen-ruler stat-icon-bg"></i>
                </div>
            </div>
        </div>
        <!-- Trending (Mock) -->
        <div class="col-md-3">
            <div class="card stat-card bg-danger text-white shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="overflow: hidden;">
                            <h6 class="text-white-50 mb-1">پربازدیدترین امروز</h6>
                            <div class="text-truncate fw-bold" style="max-width: 100%;">@(ViewBag.MostViewedTitle ?? "---")
                            </div>
                            <small class="opacity-75"><i class="fas fa-eye me-1"></i>  @(ViewBag.MostViewedCount ?? 0) بازدید</small>
                        </div>
                        <i class="fas fa-fire fa-2x opacity-50"></i>
                    </div>
                    <i class="fas fa-fire stat-icon-bg"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<section id="data-list-view" class="data-list-view-header">
    <div class="action-btns d-none">
        <div class="btn-dropdown mr-1 mb-1">
            <div class="btn-group dropdown actions-dropodown">
                <button type="button" class="btn btn-white px-1 py-1 dropdown-toggle waves-effect waves-light" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Actions
                </button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="javascript:void(0)" id="btn-delete-selected">
                        <i class="feather icon-trash"></i>Delete
                    </a>
                    <a class="dropdown-item" href="javascript:void(0)" id="btn-archive-selected">
                        <i class="feather icon-archive"></i>Add/Remove Archive
                    </a>
                    <a class="dropdown-item" href="javascript:void(0)" id="btn-open-price-modal">
                        <i class="feather icon-file"></i>Adjust the price
                    </a>
                    <a class="dropdown-item" href="#"><i class="feather icon-save"></i>Another Action</a>
                </div>
            </div>
        </div>
    </div>

    <!-- DataTable starts -->
    <div class="table-responsive">
        <table class="table data-list-view">
            <thead>
            <tr>
                <!-- ستون چک باکس یا خالی -->
                <th style="width: 10px;"></th>

                <!-- ستون ID -->
                <th class="text-center">ID</th>

                <!-- ستون تصویر -->
                <th class="text-center">IMAGE</th>

                <!-- ستون نام -->
                <th class="text-center">NAME</th>

                <!-- ستون دسته بندی (با جلوگیری از شکستن متن) -->
                <th class="text-center" style="white-space: nowrap;">CATEGORY</th>

                <th class="text-center" style="white-space: nowrap;">VIEW</th>
                <!-- ستون وضعیت (با جلوگیری از شکستن متن) -->
                <th class="text-center" style="white-space: nowrap;">STATUS</th>

                <!-- ستون موجودی -->
                <th class="text-center">INVOICE</th>

                <!-- ستون قیمت -->
                <th class="text-center">PRICE</th>

                <!-- ستون عملیات -->
                <th class="text-center">ACTION</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var item in Model) {

            <tr  data-id="@item.Id">
                <!-- ستون خالی -->
                <td></td>

                <!-- ستون ID - وسط چین -->
                <td class="text-center">
                    @Html.DisplayFor(modelItem => item.Id)
                </td>

                <!-- ستون عکس - وسط چین و حذف کلاس اضافی sorting_1 -->
                <td class="product-img text-center">
                    @if (!string.IsNullOrEmpty(item.PrimaryImage))
                    {
                    <img src="@item.PrimaryImage" width="60" height="60" style="object-fit:cover; border-radius:8px;" />
                    }
                    else
                    {
                    <span>-</span>
                    }
                </td>

                <!-- ستون نام - وسط چین -->
                <td class="product-name text-center">
                    @item.Title)
                </td>

                <!-- ستون دسته بندی - وسط چین -->
                <td class="product-category text-center">
                    @item.CategoryName
                </td>
                <td>
                    <span class="">@item.VisitCount بازدید</span>
                </td>
                <!-- ستون وضعیت فعال/غیرفعال - وسط چین -->
                <td class="text-center">
                    <span style="display:none;">@(item.IsActive ? "1" : "0")</span>
                    <div class="chip chip-@(item.IsActive ? "success" : "danger")">
                        <div class="chip-body">
                            <div class="chip-text">@(item.IsActive ? "Active" : "Inactive")</div>
                        </div>
                    </div>
                </td>
                <!-- ستون موجودی - وسط چین -->
                <td class="text-center">
                    @item.Invoice)
                </td>

                <td class="text-center">
                    @((item.Price ).ToString("N0"))
                </td>
                <!-- ستون دکمه ها - وسط چین و جلوگیری از شکستن خط -->
                <td class="text-center" style="white-space: nowrap;">
                    @Html.ActionLink("ویرایش", "AddProduct", new { id = item.Id }, new { @class = "btn btn-dark", @style="width: 80px;" })
                    <span style="margin: 0 5px;">|</span>
                    @Html.ActionLink("حذف", "DeleteProduct", new { id = item.Id }, new { @class = "btn btn-danger", @style="width: 80px;" })
                </td>
            </tr>





            }
            </tbody>
        </table>





    </div>
    <!-- DataTable ends -->


</section>


<div class="modal fade" id="priceModal" tabindex="-1" role="dialog" aria-labelledby="priceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="priceModalLabel">تغییر قیمت گروهی</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="pricePercentage">درصد تغییر قیمت را وارد کنید:</label>
                    <input type="number" class="form-control" id="pricePercentage" placeholder="مثلا 10 برای 10% افزایش">
                    <small class="text-muted">برای کاهش قیمت، عدد منفی وارد کنید (مثلا -10).</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">لغو</button>
                <button type="button" class="btn btn-primary" id="btn-confirm-price-update">اعمال</button>
            </div>
        </div>
    </div>
</div>



@section Script {
<script src="~/admin/app-assets/vendors/js/extensions/dropzone.min.js"></script>
<script src="~/admin/app-assets/vendors/js/tables/datatable/datatables.min.js"></script>
<script src="~/admin/app-assets/vendors/js/tables/datatable/datatables.buttons.min.js"></script>
<script src="~/admin/app-assets/vendors/js/tables/datatable/datatables.bootstrap4.min.js"></script>
<script src="~/admin/app-assets/vendors/js/tables/datatable/buttons.bootstrap.min.js"></script>
<script src="~/admin/app-assets/vendors/js/tables/datatable/dataTables.select.min.js"></script>
<script src="~/admin/app-assets/vendors/js/tables/datatable/datatables.checkboxes.min.js"></script>
<script src="~/admin/app-assets/js/scripts/ui/data-list-view.js"></script>
<script>
    $(document).ready(function () {
        setTimeout(function() {

            var addNewBtn = $('.dt-buttons .btn-outline-primary');
            
            addNewBtn.off('click').on('click', function (e) {
                e.preventDefault();
                window.location.href = '@Url.Action("AddProduct", "Admin")'; // هدایت به صفحه افزودن
            });
            
            addNewBtn.css('cursor', 'pointer');
        }, 1000);
    });
</script>

<script>
    $(document).ready(function () {

        $('#btn-delete-selected').on('click', function () {

            var selectedIds = [];

         
            $('.data-list-view tbody tr.selected').each(function () {
                var id = $(this).data('id');
                if (id) {
                    selectedIds.push(id);
                }
            });

            if (selectedIds.length === 0) {
                alert("لطفاً حداقل یک محصول را انتخاب کنید.");
                return;
            }

            if (!confirm("آیا از حذف " + selectedIds.length + " محصول انتخاب شده اطمینان دارید؟")) {
                return;
            }

            $.ajax({
                url: '/Admin/DeleteGroupProduct', 
                type: 'POST',
                data: { ids: selectedIds },
                traditional: true,
                success: function (response) {
                    if (response.success) {
       
                        location.reload();
                    } else {
                        alert("خطا در حذف: " + response.message);
                    }
                },
                error: function () {
                    alert("خطا در برقراری ارتباط با سرور.");
                }
            });
        });
    });
</script>


<script>
    $(document).ready(function () {
        
        $('#btn-archive-selected').on('click', function () {
            
            var selectedIds = [];
            $('.data-list-view tbody tr.selected').each(function () {
                var id = $(this).data('id');
                if (id) {
                    selectedIds.push(id);
                }
            });
            
            if (selectedIds.length === 0) {
                alert("لطفاً حداقل یک محصول را انتخاب کنید.");
                return;
            }
            
            $.ajax({
                url: '/Admin/ChangeStatusGroupProduct', 
                type: 'POST',
                data: { ids: selectedIds },
                traditional: true,
                success: function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert("خطا: " + response.message);
                    }
                },
                error: function () {
                    alert("خطا در ارتباط با سرور.");
                }
            });
        });

    });
</script>

<script>
    $(document).ready(function () {
        
        $('#btn-archive-selected').on('click', function () {
            var selectedIds = [];
            $('.data-list-view tbody tr.selected').each(function () {
                var id = $(this).data('id');
                if (id) selectedIds.push(id);
            });

            if (selectedIds.length === 0) {
                alert("لطفاً محصولی انتخاب کنید.");
                return;
            }

            $.ajax({
                url: '/Admin/ChangeStatusGroupProduct',
                type: 'POST',
                data: { ids: selectedIds },
                traditional: true,
                success: function (res) {
                    if (res.success) location.reload();
                    else alert(res.message);
                }
            });
        });


        var priceSelectedIds = [];


        $('#btn-open-price-modal').on('click', function () {
            priceSelectedIds = [];
            
            $('.data-list-view tbody tr.selected').each(function () {
                var id = $(this).data('id'); 
                if (id) {
                    priceSelectedIds.push(id);
                }
            });

            if (priceSelectedIds.length === 0) {
                alert("لطفاً حداقل یک محصول را انتخاب کنید.");
                return;
            }
            
            $('#priceModal').modal('show');
        });
        
        $('#btn-confirm-price-update').on('click', function () {
            var percent = $('#pricePercentage').val();
            if (!percent) {
                alert("لطفاً درصد را وارد کنید.");
                return;
            }

            $.ajax({
                url: '/Admin/UpdatePriceGroup',
                type: 'POST',
                data: {
                    ids: priceSelectedIds,
                    percentage: percent
                },
                traditional: true,
                success: function (response) {
                    $('#priceModal').modal('hide');
                    if (response.success) {
                        location.reload();
                    } else {
                        alert("خطا: " + response.message);
                    }
                },
                error: function () {
                    $('#priceModal').modal('hide');
                    alert("خطا در ارتباط با سرور.");
                }
            });
        });

    });
</script>
}