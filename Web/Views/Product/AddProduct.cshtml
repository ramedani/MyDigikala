@model Application.DTO.EditProductDto

@{
    ViewData["Title"] = Model.Id == 0 ? "افزودن محصول جدید" : $"ویرایش محصول: {Model.Title}";
    Layout = "~/Views/Shared/_Admin.cshtml";
}

@section css {
    <style>
        #colorDropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        #colorMenu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #1d1d1d;
            border: 1px solid #3b3b3b;
            border-radius: 8px;
            width: 100%;
            max-height: 280px;
            overflow-y: auto;
            z-index: 99999 !important;
        }

        .color-item {
            padding: 10px 12px;
            color: #fff;
            border-radius: 6px;
            margin: 4px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-item span {
            font-weight: 600;
        }

        .color-item:hover {
            filter: brightness(1.3);
        }

        .color-item.selected {
            outline: 2px solid #7b3ef3;
        }
        .category-action {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            color: #7b61ff;
            font-size: 30px;
        }

        .category-action i {
            font-size: 30px;
        }
    </style>
}

<!-- تگ form باید کل محتوا را در بر بگیرد -->
<form asp-action="AddProduct" asp-controller="Admin" method="post" enctype="multipart/form-data">

    <!-- ارسال AntiForgeryToken برای امنیت -->
    @Html.AntiForgeryToken()
    <!-- ID محصول برای حالت ویرایش به صورت مخفی ارسال می‌شود -->
    <input type="hidden" asp-for="Id" />
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="content-detached content-right">
        <div class="content-body">
            <div class="row">
                <div class="col-12">

                    <!-- فیلدهای اصلی محصول -->
                    <div class="form-group">
                        <label asp-for="Title" class="control-label"></label>
                        <input asp-for="Title" class="form-control" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <!-- FIX: تگ divSlogan به div class="form-group" اصلاح شد -->
                 

                    <div class="form-group">
                        <label asp-for="Description" class="control-label"></label>
                        <!-- FIX: استفاده از asp-for برای اتصال صحیح به مدل -->
                        <textarea id="Content" asp-for="Description" class="form-control"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="row">
                  
          
                    </div>

                    <hr />

                    <!-- بخش مدیریت تصاویر -->
                    <div class="form-group">
                        <label>آپلود عکس‌های جدید</label>
                        <input type="file" name="NewImages" accept="image/*" multiple class="form-control-file" />
                    </div>

                    @if (Model.Id == 0)
                    {
                        <div class="alert alert-info mt-2">
                            ابتدا محصول را با فشردن دکمه ثبت، ذخیره کنید تا بتوانید عکس‌ها را مشاهده و مدیریت کنید.
                        </div>
                    }

                    @if (Model.Id > 0 && Model.ExistingImages != null && Model.ExistingImages.Any())
                    {
                        <h5 class="mt-4">تصاویر فعلی محصول</h5>
                        <div class="row border p-2 rounded bg-light">
                            @foreach (var img in Model.ExistingImages)
                            {
                                <div class="col-md-3 text-center mb-3" id="img-box-@img.Id">
                                    <div class="card">
                                        <img src="~/upload/@img.PicUrl" alt="Product Image" class="card-img-top" style="height: 120px; object-fit: cover;" />
                                        <div class="card-body p-2">
                                           
                                            <button type="button" class="btn btn-danger btn-sm mt-2 btn-block" onclick="deleteImage(@img.Id)">
                                                <i class="fa fa-trash"></i> حذف
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <hr />

                    <!-- دکمه‌های نهایی -->
                    <div class="form-group">
                        <input type="submit" value="ذخیره تغییرات" class="btn btn-primary" />
                        <a asp-action="ProductList" asp-controller="Admin" class="btn btn-secondary">بازگشت به لیست</a>

                        <!-- FIX: لینک حذف خطرناک با یک فرم امن جایگزین شد -->
                        @if (Model.Id > 0)
                        {
                            <button type="submit" asp-action="DeleteProduct" asp-route-id="@Model.Id"
                                    class="btn btn-danger float-right"
                                    onclick="return confirm('آیا از حذف کامل این محصول مطمئن هستید؟ این عمل غیرقابل بازگشت است.');">
                                حذف محصول
                            </button>
                        }
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="sidebar-detached sidebar-left">
        <div class="sidebar">
            <div class="sidebar-shop show" id="ecommerce-sidebar-toggler">
                <div class="card">
                    <div class="card-body">
                        <!-- قیمت‌ها -->
                        <h6 class="filter-title mb-0">قیمت‌گذاری</h6>
                 
                        <div class="form-group">
                            <label asp-for="Price"></label>
                            <input asp-for="Price" id="Price" class="form-control" />
                        </div>
                     
                       
                        <hr />
                        <div class="form-group">
                            <label asp-for="Invoice"></label>
                            <input asp-for="Invoice" id="Invoice" class="form-control" />
                        </div>

                        <!-- دسته‌بندی‌ها -->
                        <div id="product-categories">
                            <h6 class="filter-title mb-1">دسته‌بندی</h6>
                      
                        </div>
                        <div class="form-group mt-2">
                            <label class="d-block">مدیریت دسته بندی ‌ها:</label>
                            <a href="/admin/AddCategory" title="افزودن برند جدید">
                                <div class="category-action">
                                    <i class="feather icon-plus"></i>
                                </div>
                            </a>
                            <a href="/admin/CategoryList" title="ویرایش دسته بندی ها" class="ml-1">
                                <div class="category-action">
                                    <i class="feather icon-edit-2" style="width: 45px;"></i>
                                </div>
                            </a>
                        </div>

                        <hr />

                        <hr>

                        <!-- رنگ‌ها -->
                        <div class="brands">
                            <h6 class="filter-title mb-0">رنگ</h6>
                     
                        </div>
                        <div class="form-group mt-2">
                            <label class="d-block">مدیریت رنگ ‌ها:</label>
                            <a href="/admin/AddColor" title="افزودن برند جدید">
                                <div class="category-action">
                                    <i class="feather icon-plus"></i>
                                </div>
                            </a>
                            <a href="/admin/ListColor" title="ویرایش رنگ ها" class="ml-1">
                                <div class="category-action">
                                    <i class="feather icon-edit-2" style="width: 45px;"></i>
                                </div>
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section script {
    <script src="~/tinymce/tinymce.js"></script>
    <script>
        tinymce.init({
            selector: '#Content',
            license_key: 'gpl'
        });

        // FIX: فقط یک تابع برای حذف عکس با استفاده از jQuery (که در صفحه موجود است)
        function deleteImage(imageId) {
            if (!confirm('آیا از حذف این عکس مطمئن هستید؟')) return;

            $.ajax({
                url: '/Admin/DeleteImage', // نام اکشن صحیح
                type: 'POST',
                // ارسال توکن امنیتی برای جلوگیری از حملات CSRF
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                data: { imageId: imageId },
                success: function(response) {
                    if (response.success) {
                        $('#img-box-' + imageId).fadeOut(500, function() { $(this).remove(); });
                    } else {
                        alert(response.message || 'خطا در حذف تصویر. لطفا دوباره تلاش کنید.');
                    }
                },
                error: function() {
                    alert('خطای سرور. لطفا با پشتیبانی تماس بگیرید.');
                }
            });
        }


    </script>

    <!-- اگر از Layout پیش‌فرض استفاده می‌کنید، اسکریپت‌های اعتبارسنجی را نگه دارید -->
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 1. دریافت المان‌های ورودی بر اساس ID
            // نکته: مطمئن شوید که id های داخل پرانتز دقیقاً با id های input های شما یکی باشد
            const priceInput = document.getElementById("Price");
            const percentInput = document.getElementById("DiscountPercentage");
            const finalPriceInput = document.getElementById("Discount"); // در تصویر شما لیبل Discount دارد

            // تابع کمکی برای تبدیل مقدار ورودی به عدد
            function getNumber(input) {
                if (!input || !input.value) return 0;
                // حذف کاما یا کاراکترهای غیر عددی اگر وجود دارد
                return parseFloat(input.value.replace(/,/g, '')) || 0;
            }

            // 2. محاسبه قیمت نهایی (وقتی درصد یا قیمت اصلی تغییر می‌کند)
            function calculateFinalPrice() {
                const price = getNumber(priceInput);
                const percent = getNumber(percentInput);

                if (price > 0) {
                    // فرمول: قیمت نهایی = قیمت اصلی * (1 - درصد/100)
                    const finalPrice = price * (1 - (percent / 100));

                    // رند کردن عدد به نزدیکترین مقدار صحیح
                    finalPriceInput.value = Math.round(finalPrice);
                }
            }

            // 3. محاسبه درصد تخفیف (وقتی قیمت نهایی تغییر می‌کند)
            function calculatePercent() {
                const price = getNumber(priceInput);
                const finalPrice = getNumber(finalPriceInput);

                if (price > 0 && finalPrice <= price) {
                    // فرمول: درصد = ((قیمت اصلی - قیمت نهایی) / قیمت اصلی) * 100
                    let percent = ((price - finalPrice) / price) * 100;

                    // محدود کردن اعشار به 2 رقم (مثلاً 12.50)
                    // اگر عدد صحیح بود، اعشار حذف می‌شود
                    percentInput.value = parseFloat(percent.toFixed(2));
                } else if (finalPrice > price) {
                    // اگر قیمت نهایی از قیمت اصلی بیشتر شد، درصد را صفر کن (حالت غیرمنطقی)
                    percentInput.value = 0;
                }
            }

            // 4. اختصاص دادن رویدادها (Events)

            // وقتی "درصد" تغییر کرد -> قیمت نهایی محاسبه شود
            if (percentInput) {
                percentInput.addEventListener("input", calculateFinalPrice);
                percentInput.addEventListener("change", calculateFinalPrice);
            }

            // وقتی "قیمت نهایی" تغییر کرد -> درصد محاسبه شود
            if (finalPriceInput) {
                finalPriceInput.addEventListener("input", calculatePercent);
                finalPriceInput.addEventListener("change", calculatePercent);
            }

            // وقتی "قیمت اصلی" تغییر کرد -> معمولاً قیمت نهایی را مجدداً بر اساس درصد فعلی حساب می‌کنیم
            if (priceInput) {
                priceInput.addEventListener("input", calculateFinalPrice);
            }
        });
    </script>


}